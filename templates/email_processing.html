{% extends "base.html" %}

{% block title %}Email Processing - Resume Scanner{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="fas fa-envelope me-2"></i>
                Email Processing
            </h1>
            <p class="lead text-muted">Automatically process resumes from email attachments</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h4>{{ stats.total_processed }}</h4>
                    <p class="text-muted mb-0">Processed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                    <h4>{{ stats.total_failed }}</h4>
                    <p class="text-muted mb-0">Failed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-minus-circle fa-2x text-warning mb-2"></i>
                    <h4>{{ stats.total_skipped }}</h4>
                    <p class="text-muted mb-0">Skipped</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-envelope fa-2x text-info mb-2"></i>
                    <h4>{{ stats.total_emails }}</h4>
                    <p class="text-muted mb-0">Total Emails</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Emails Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Process New Emails
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Email Configuration Required:</strong> To use email processing, configure your email settings in the environment variables:
                        EMAIL_USER, EMAIL_PASSWORD, IMAP_SERVER, etc.
                    </div>
                    
                    <form method="POST" action="{{ url_for('process_emails') }}">
                        <div class="mb-3">
                            <label for="job_description" class="form-label">Default Job Description (Optional)</label>
                            <textarea class="form-control" id="job_description" name="job_description" 
                                      rows="4" placeholder="Provide a default job description to use for analyzing resumes from emails..."></textarea>
                            <div class="form-text">
                                If no job description is provided, the system will try to extract one from the email content.
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync me-2"></i>Process New Emails
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Guide -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>Email Configuration Guide
                    </h5>
                </div>
                <div class="card-body">
                    <p>To enable automatic email processing, add these environment variables to your Replit Secrets:</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Gmail Configuration:</h6>
                            <ul class="list-unstyled">
                                <li><code>EMAIL_USER</code>: your-email@gmail.com</li>
                                <li><code>EMAIL_PASSWORD</code>: your-app-password</li>
                                <li><code>IMAP_SERVER</code>: imap.gmail.com</li>
                                <li><code>IMAP_PORT</code>: 993</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Other Email Providers:</h6>
                            <ul class="list-unstyled">
                                <li><strong>Outlook:</strong> outlook.office365.com:993</li>
                                <li><strong>Yahoo:</strong> imap.mail.yahoo.com:993</li>
                                <li><strong>Apple:</strong> imap.mail.me.com:993</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Security Note:</strong> Use app-specific passwords instead of your main email password. 
                        For Gmail, enable 2FA and generate an app password.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Processing Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Recent Processing Logs
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_logs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Sender</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Candidate</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_logs %}
                                    <tr>
                                        <td>{{ log.processed_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ log.sender_email }}</td>
                                        <td>
                                            {{ log.subject[:50] }}{% if log.subject|length > 50 %}...{% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if log.status == 'processed' else 'danger' if log.status == 'failed' else 'warning' }}">
                                                {{ log.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if log.resume_analysis_id %}
                                                <i class="fas fa-user-check text-success"></i> Created
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.resume_analysis_id %}
                                                <a href="{{ url_for('candidate_detail', candidate_id=log.resume_analysis_id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                            {% else %}
                                                {% if log.error_message %}
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="tooltip" 
                                                            title="{{ log.error_message }}">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>Error
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5>No email processing logs yet</h5>
                            <p class="text-muted">Configure your email settings and process some emails to see logs here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}